# ckanext-searchterms

This plugin enables the asynchronous parsing of data files to tag both molecules found within the file and their synonyms. For more information on what lookups are used for each datatype and our strategy for each, please see the tagging section of [the mapMECFS about page](https://www.mapmecfs.org/about) and [parser.py](http://gitlab.rtp.rti.org/mecfs/ckanext-mecfs-genetags/blob/master/ckanext/genetags/parser.py) in this repository. The tagged genes and molecules are stored as a resource in the package, and also parsed at the time of indexing to become searchable.

Note that this plugin relies on schema alterations and template extensions present in the `ckanext-mecfs` extension, and as such this plugin should be included after that one in installation.

### Workflow
* After a resource is created or updated including a new file upload, the existing resource is deleted if it exists, and we check to see if the file type is `Data File`
* If so, we enqueue the `create_search_terms_resource` function as a job
* The parent package is retrieved, and validated, then the resource and package are passed to the parser.
    * The parser (`parser.py`) contains all of our strategies for extracting molecules and finding synonyms. See above for reference on our logic for how to do that.
* The dict returned by the parser is post-processed to re-order columns and to remove NAs as some molecules have more synonyms than others
* the dataframe is saved as a tsv, then added to the resource

### Indexing
Whenever a package is indexed, if it has a resource generated by this plugin, this resource will be parsed. In order to both not index each search term individually (slow) and also not exceed the maximum size of a searchable string in SOLR, we tokenize and convert to json each of these files in `plugin.py before_index` and save the json as searchable terms.
